<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¡ç®—å› å­åˆ†æ</title>
    <script src="../lib/echarts.min.js"></script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/dexie.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 5px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background-color: #fff;
            padding: 3.75px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 1px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }

        .toolbar-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-item label {
            font-size: 13px;
            color: #333;
            white-space: nowrap;
            font-weight: 500;
        }

        .toolbar-item input[type="datetime-local"],
        .toolbar-item select {
            padding: 3px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.3s;
            min-width: 100px;
        }

        .toolbar-item input[type="datetime-local"]:focus,
        .toolbar-item select:focus {
            border-color: #409eff;
            box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
        }

        .toolbar-item button {
            padding: 3px 20px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            outline: none;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #409eff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #66b1ff;
        }

        .btn-primary:disabled {
            background-color: #a0cfff;
            cursor: not-allowed;
        }

        .btn-default {
            background-color: #fff;
            color: #333;
            border: 1px solid #dcdfe6;
        }

        .btn-default:hover {
            color: #409eff;
            border-color: #c6e2ff;
            background-color: #ecf5ff;
        }

        /* æ·±è‰²ä¸»é¢˜æ ·å¼ */
        body.dark-theme {
            background-color: #1a1a1a;
            color: #e4e7ed;
        }

        body.dark-theme .container {
            background-color: #1a1a1a;
        }

        body.dark-theme .toolbar {
            background-color: #2d2d2d;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        body.dark-theme .toolbar-item label {
            color: #e4e7ed;
        }

        body.dark-theme .toolbar-item input[type="datetime-local"],
        body.dark-theme .toolbar-item select {
            background-color: #3d3d3d;
            border-color: #4c4d4f;
            color: #e4e7ed;
        }

        body.dark-theme .toolbar-item input[type="datetime-local"]:focus,
        body.dark-theme .toolbar-item select:focus {
            border-color: #409eff;
            background-color: #3d3d3d;
        }

        body.dark-theme .btn-default {
            background-color: #3d3d3d;
            color: #e4e7ed;
            border-color: #4c4d4f;
        }

        body.dark-theme .btn-default:hover {
            color: #409eff;
            border-color: #409eff;
            background-color: #2d4a87;
        }

        body.dark-theme .chart-container {
            background-color: #2d2d2d;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        body.dark-theme .chart-item {
            background-color: #1e1e1e;
            border-color: #3d3d3d;
        }

        body.dark-theme .loading {
            color: #909399;
        }

        .chart-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            flex: 1;
            min-height: 0;
            padding: 1px 1px 1px 1px;
            box-sizing: border-box;
        }

        .chart-item {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            color: #666;
            z-index: 1000;
        }

        /* éŸ³ä¹æ’­æ”¾å™¨é£æ ¼æŒ‰é’® */
        #prev-btn,
        #play-btn,
        #next-btn {
            width: 36px;
            height: 24px;
            /* border-radius: 50%; */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 13px;
        }

        #play-btn {
            background-color: #1db954;
            /* éŸ³ä¹æ’­æ”¾å™¨å¸¸ç”¨çš„ç»¿è‰² */
            border: none;
        }

        #play-btn:hover {
            background-color: #1ed760;
        }

        body.dark-theme .btn-default:hover {
            color: #409eff;
            border-color: #409eff;
            background-color: #4c4d4f;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 5px;
            border-radius: 3px;
            width: 95%;
            max-width: 1000px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .modal-body {
            padding: 10px 0;
        }

        .modal-footer {
            padding: 10px 0;
            border-top: 1px solid #eee;
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .config-group {
            margin-bottom: 15px;
        }

        .config-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .config-group input[type="number"],
        .config-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
        }

        .config-group input[type="checkbox"] {
            margin-right: 8px;
        }

        /* æ·±è‰²ä¸»é¢˜ä¸‹çš„æ¨¡æ€æ¡†æ ·å¼ */
        body.dark-theme .modal-content {
            background-color: #2d2d2d;
            color: #e4e7ed;
        }

        body.dark-theme .modal-header {
            border-bottom-color: #4c4d4f;
        }

        body.dark-theme .modal-header h2 {
            color: #e4e7ed;
        }

        body.dark-theme .modal-footer {
            border-top-color: #4c4d4f;
        }

        body.dark-theme .config-group label {
            color: #e4e7ed;
        }

        body.dark-theme .config-group input[type="number"],
        body.dark-theme .config-group select {
            background-color: #3d3d3d;
            border-color: #4c4d4f;
            color: #e4e7ed;
        }

        .symbol-input-wrapper {
            position: relative;
            display: inline-block;
            width: 180px;
            /* è®¾ç½®å›ºå®šå®½åº¦ï¼Œä¸å…¶ä»–è¾“å…¥æ¡†ä¿æŒä¸€è‡´ */
        }

        /* è¾“å…¥æ¡†åŸºç¡€æ ·å¼ */
        #symbol-input {
            width: 100%;
            height: 24px;
            padding: 0 12px;
            border: 1px solid #409eff;
            border-radius: 4px;
            background-color: #fff;
            color: #606266;
            transition: border-color 0.3s;
            box-sizing: border-box;
            font-size: 13px;
        }

        /* è¾“å…¥æ¡†èšç„¦æ ·å¼ */
        #symbol-input:focus {
            outline: none;
            border-color: #409eff;
            box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
        }

        /* è¾“å…¥æ¡†å ä½ç¬¦æ ·å¼ */
        #symbol-input::placeholder {
            color: #409eff;
        }

        /* ç»“æœä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */
        .symbol-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ç»“æœé¡¹æ ·å¼ */
        .symbol-result-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            color: #606266;
            font-size: 13px;
        }

        .symbol-result-item:last-child {
            border-bottom: none;
        }

        .symbol-result-item:hover {
            background-color: #f5f5f5;
        }

        /* é«˜äº®é€‰ä¸­é¡¹ */
        .symbol-result-item.highlight {
            background-color: #ecf5ff;
            color: #409eff;
        }

        .symbol-results.hidden {
            display: none;
        }

        /* æ·±è‰²ä¸»é¢˜æ ·å¼ */
        body.dark-theme #symbol-input {
            background-color: #3d3d3d;
            border-color: #4c4d4f;
            color: #e4e7ed;
        }

        body.dark-theme #symbol-input:focus {
            border-color: #409eff;;
            box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.1);
        }

        body.dark-theme #symbol-input::placeholder {
            color: #909399;
        }

        body.dark-theme .symbol-results {
            background-color: #3d3d3d;
            border-color: #4c4d4f;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        body.dark-theme .symbol-result-item {
            border-bottom-color: #4c4d4f;
            color: #e4e7ed;
        }

        body.dark-theme .symbol-result-item:hover {
            background-color: #4c4d4f;
        }

        body.dark-theme .symbol-result-item.highlight {
            background-color: #2d4a87;
            color: #409eff;
        }

        .toolbar-item input[type="datetime-local"],
        .toolbar-item select {
            padding: 3px 12px;
            border: 1px solid #409eff;
            /* æµ…ç»¿è‰²è¾¹æ¡† */
            border-radius: 3px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.3s;
            min-width: 100px;
        }

        /* ä¸ºfactor-selectä¸‹æ‹‰åˆ—è¡¨è®¾ç½®å›ºå®šå®½åº¦ */
        #factor-select {
            width: 140px;
            /* è®¾ç½®å›ºå®šå®½åº¦ */
            min-width: 140px;
            /* ç¡®ä¿æœ€å°å®½åº¦ä¹Ÿä¸ºå›ºå®šå€¼ */
        }

        .toolbar-item input[type="datetime-local"]:focus,
        .toolbar-item select:focus {
            border-color: #409eff;
            box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
        }


        /* çŠ¶æ€æ æ ·å¼ */
        #status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #333;
        }

        #status-bar > div {
            padding: 0 5px;
        }

        /* å†å²è®°å½•æ ·å¼ */
        #status-bar > div:last-child {
            margin-left: auto;
            cursor: pointer;
        }

        #status-bar > div:last-child:hover {
            color: #409eff;
        }

        /* æ·±è‰²ä¸»é¢˜ä¸‹çš„çŠ¶æ€æ æ ·å¼ */
        body.dark-theme #status-bar {
            background-color: #2d2d2d;
            color: #e4e7ed;
            border-top-color: #4c4d4f;
        }

        body.dark-theme #status-bar > div:last-child:hover {
            color: #66b1ff;
        }

        /* å†å²è®°å½•è¡¨æ ¼æ ·å¼ */
        #history-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        #history-table th,
        #history-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word;
        }

        .history-col-stock {
            width: 12%;
        }

        .history-col-start {
            width: 15%;
        }

        .history-col-end {
            width: 15%;
        }

        .history-col-db {
            width: 10%;
        }

        .history-col-factor {
            width: 10%;
        }

        .history-col-type {
            width: 10%;
        }

        .history-col-color {
            width: 8%;
        }

        .history-col-width {
            width: 10%;
        }

        /* æ·±è‰²ä¸»é¢˜ä¸‹çš„è¡¨æ ¼æ ·å¼ */
        body.dark-theme #history-table th,
        body.dark-theme #history-table td {
            border-bottom-color: #4c4d4f;
        }

        /* çŠ¶æ€æ æ ·å¼ */
        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #66b1ff;
            padding: 5px 10px;
            border-top: 1px solid #66b1ff;
            display: flex;
            justify-content: flex-end;
            gap: 20px;
        }

        .status-bar-content {
            display: flex;
            gap: 20px;
        }

        .status-item {
            color: white;
            cursor: pointer;
        }

        .status-item:hover {
            color: #e6f7ff;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-item {
                justify-content: space-between;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-item">
            <label for="symbol-input">è‚¡ç¥¨åç§°(ä»£ç ):</label>
            <div class="symbol-input-wrapper">
                <input type="text" id="symbol-input" placeholder="è¯·è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°" value="äº” ç²® æ¶²[000858]"
                       autocomplete="off">
                <input type="hidden" id="symbol-hidden" value="SZSE.000858">
                <div id="symbol-results" class="symbol-results hidden"></div>
            </div>
        </div>
        <div class="toolbar-item">
            <label for="start-time">å¼€å§‹æ—¶é—´:</label>
            <input type="datetime-local" id="start-time" step="1">
        </div>
        <div class="toolbar-item">
            <label for="end-time">ç»“æŸæ—¶é—´:</label>
            <input type="datetime-local" id="end-time" step="1">
        </div>
        <div class="toolbar-item">
            <label for="factor-database-select">å› å­åº“:</label>
            <select id="factor-database-select">
            </select>
        </div>
        <div class="toolbar-item">
            <label for="factor-select">å› å­:</label>
            <select id="factor-select">
            </select>
        </div>
        <div class="toolbar-item">
            <label for="grid-select">æ•°æ®è§†å›¾:</label>
            <select id="grid-select">
            </select>
        </div>
        <div class="toolbar-item">
            <label for="view-type-select">è§†å›¾ç±»å‹:</label>
            <select id="view-type-select">
                <option value="line">æŠ˜çº¿å›¾</option>
                <option value="bar">æŸ±çŠ¶å›¾</option>
            </select>
        </div>
        <div class="toolbar-item">
            <button id="query-btn" class="btn-primary">æŸ¥è¯¢æ•°æ®</button>
        </div>
        <div class="toolbar-item">
            <button id="cg-btn" class="btn-primary">å›¾åƒè½¬æ¢</button>
        </div>
        <div class="toolbar-item">
            <button id="color-config-btn" class="btn-primary">é…ç½®é¢œè‰²</button>
        </div>
        <div class="toolbar-item">
            <button id="delete-btn" class="btn-primary">åˆ é™¤æŒ‡æ ‡æ•°æ®</button>
        </div>
        <div class="toolbar-item">
            <button id="save-page-layout-btn" class="btn-primary">ä¿å­˜é¡µé¢å¸ƒå±€</button>
        </div>
        <div class="toolbar-item" style="margin-left: auto;">
            <button id="prev-btn" class="btn-primary">â—€</button>
        </div>
        <div class="toolbar-item">
            <button id="play-btn" class="btn-primary">â–¶</button>
        </div>
        <div class="toolbar-item">
            <button id="next-btn" class="btn-primary">â–¶</button>
        </div>
        <div class="toolbar-item">
            <button id="theme-toggle" class="btn-default">ğŸŒ™</button>
        </div>
        <div class="toolbar-item">
            <button id="config-btn" class="btn-default">âš™ï¸</button>
        </div>
    </div>

    <!-- å›¾è¡¨å®¹å™¨ -->
    <div class="chart-container">
        <div class="chart-item">
            <div id="multi-grid-chart" style="width: 100%; height: 100%;"></div>
            <div class="loading" id="chart-loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
</div>

<!-- é€šç”¨é…ç½®æ¨¡æ€æ¡† -->
<div id="config-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>âš™ï¸ é…ç½®é€‰é¡¹</h2>
        </div>
        <div class="modal-body">
            <div class="config-group">
                <label for="play-interval">è‡ªåŠ¨æ’­æ”¾é—´éš”ï¼ˆç§’ï¼‰:</label>
                <input type="number" id="play-interval" min="1" max="30" value="3">
            </div>
            <div class="config-group">
                <label for="chart-theme">å›¾è¡¨ä¸»é¢˜:</label>
                <select id="chart-theme">
                    <option value="auto">è·Ÿéšç³»ç»Ÿ</option>
                    <option value="light">æµ…è‰²ä¸»é¢˜</option>
                    <option value="dark">æ·±è‰²ä¸»é¢˜</option>
                </select>
            </div>
            <div class="config-group">
                <label>
                    <input type="checkbox" id="show-grid" checked>
                    æ˜¾ç¤ºç½‘æ ¼çº¿
                </label>
            </div>
            <div class="config-group">
                <label>
                    <input type="checkbox" id="show-legend" checked>
                    æ˜¾ç¤ºå›¾ä¾‹
                </label>
            </div>
            <div class="config-group">
                <label for="data-points">æ•°æ®ç‚¹æ˜¾ç¤º:</label>
                <select id="data-points">
                    <option value="show">æ˜¾ç¤º</option>
                    <option value="hide">éšè—</option>
                    <option value="hover">ä»…æ‚¬åœæ˜¾ç¤º</option>
                </select>
            </div>
            <!-- æ·»åŠ ç½‘æ ¼æ•°é‡é…ç½®é¡¹ -->
            <div class="config-group">
                <label for="grid-count">æ•°æ®è§†å›¾æ•°é‡:</label>
                <select id="grid-count">
                    <option value="1" selected>1ä¸ª</option>
                    <option value="2">2ä¸ª</option>
                    <option value="3">3ä¸ª</option>
                    <option value="4">4ä¸ª</option>
                    <option value="5">5ä¸ª</option>
                    <option value="6">6ä¸ª</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancel-config" class="btn-default">å–æ¶ˆ</button>
            <button id="save-config" class="btn-primary">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<!-- SERIESé…ç½®æ¨¡æ€æ¡† -->
<div id="color-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ¨ é…ç½®æ ·å¼</h2>
        </div>
        <div class="modal-body">
            <div class="config-group">
                <label for="series-color">é¢œè‰²:</label>
                <input type="color" id="series-color" value="#409eff">
            </div>
            <div class="config-group" id="line-width-group">
                <label for="line-width">çº¿æ¡ç²—ç»†:</label>
                <input type="range" id="line-width" min="0.1" max="1.5" step="0.1" value="0.8">
                <span id="line-width-value">2</span>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancel-color" class="btn-default">å–æ¶ˆ</button>
            <button id="save-color" class="btn-primary">åº”ç”¨</button>
        </div>
    </div>
</div>

<!--æŸ¥è¯¢å†å²modal-->
<div id="history-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ“‹ å†å²è®°å½•</h2>
        </div>
        <div class="modal-body">
            <table id="history-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                <tr>
                    <th class="history-col-stock">è‚¡ç¥¨</th>
                    <th class="history-col-start">å¼€å§‹æ—¶é—´</th>
                    <th class="history-col-end">ç»“æŸæ—¶é—´</th>
                    <th class="history-col-db">å› å­åº“</th>
                    <th class="history-col-factor">å› å­è§†å›¾</th>
                    <th class="history-col-type">å›¾å½¢ç±»å‹</th>
                    <th class="history-col-color">é¢œè‰²</th>
                    <th class="history-col-width">çº¿æ¡ç²—ç»†</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button id="clear-history" class="btn-danger" style="margin-right: 10px;">æ¸…ç©ºå†å²</button>
            <button id="close-history" class="btn-default">å…³é—­</button>
        </div>
    </div>
</div>

<!-- çŠ¶æ€æ  -->
<div id="status-bar">
    <div class="status-bar-content">
        <div id="query-history-div" class="status-item">æŸ¥è¯¢è®°å½•: <span id="history-count">0</span> æ¡</div>
        <div id="layout-history-div" class="status-item">å¸ƒå±€è®°å½•: <span id="layout-history-count">0</span> æ¡</div>
        <div class="status-item">å½“å‰æ—¶é—´: <span id="current-time"></span></div>
    </div>
</div>

<script>
    const uri = {
        'base-stock': '/api/analysis/v1/data/base-stock',
        'factor-query': '/api/analysis/v1/factor/query'
    }

    const db = new Dexie('finance');

    $(document).ready(function () {
        db.version(2).stores({
            query_history: '++time, db, tb, cs, grid, line_width, color, view_type, start_time, end_time',
            page_layout: '++save_time, grid_count, &queries'
        });

        // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
        const multiGridChart = echarts.init(document.getElementById('multi-grid-chart'));

        // åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨
        const today = new Date();

        const fmt_start_time = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            // const hours = String(date.getHours()).padStart(2, '0');
            // const minutes = String(date.getMinutes()).padStart(2, '0');
            // const seconds = String(date.getSeconds()).padStart(2, '0');
            const hours = '09';
            const minutes = '30';
            const seconds = '00';
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        };

        const fmt_end_time = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            // const hours = String(date.getHours()).padStart(2, '0');
            // const minutes = String(date.getMinutes()).padStart(2, '0');
            // const seconds = String(date.getSeconds()).padStart(2, '0');
            const hours = '14';
            const minutes = '57';
            const seconds = '00';
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        };

        $('#start-time').val(fmt_start_time(new Date(today.getTime() - 24 * 60 * 60 * 1000)));
        $('#end-time').val(fmt_end_time(today));

        let base_stock = [];

        $.ajax({
            url: uri['base-stock'],
            type: 'GET',
            async: false,
            success: function (data) {
                base_stock = data;
            },
            error: function (xhr, status, error) {
                console.error('Failed to fetch stock data:', error);
            }
        });

        const get_symbol = (symbol) => {
            return base_stock.filter(stock =>
                stock.name.includes(symbol) || stock.code.includes(symbol)
            );
        };

        // è‚¡ç¥¨è¾“å…¥æ¡†äº‹ä»¶å¤„ç†
        const symbolInput = $('#symbol-input');
        const symbolResults = $('#symbol-results');
        let currentSelectedIndex = -1;
        let searchTimeout;

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        const showResults = (results) => {
            symbolResults.empty().removeClass('hidden');
            currentSelectedIndex = -1;

            // åº”ç”¨ä¸»é¢˜æ ·å¼
            if (isDarkTheme) {
                symbolResults.addClass('dark-theme');
            } else {
                symbolResults.removeClass('dark-theme');
            }

            if (results.length === 0) {
                const noResult = $('<div class="symbol-result-item">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è‚¡ç¥¨</div>');
                if (isDarkTheme) {
                    noResult.addClass('dark-theme');
                }
                symbolResults.append(noResult);
                return;
            }

            results.forEach((stock, index) => {
                const item = $('<div class="symbol-result-item"></div>');
                item.text(`${stock.name}[${stock.code}]`);
                item.data('stock', stock);

                if (isDarkTheme) {
                    item.addClass('dark-theme');
                }

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                item.click(() => {
                    selectStock(stock);
                });

                symbolResults.append(item);
            });
        };

        // é€‰æ‹©è‚¡ç¥¨
        const selectStock = (stock) => {
            symbolInput.val(stock.name + '[' + stock.code + ']');
            symbolResults.addClass('hidden');
            localStorage.setItem('selectedStock', JSON.stringify(stock));
            // è®¾ç½®éšè—è¾“å…¥æ¡†çš„å€¼ä¸ºè‚¡ç¥¨çš„symbol
            $('#symbol-hidden').val(stock.symbol);
        };

        // è¾“å…¥æ¡†è¾“å…¥äº‹ä»¶
        symbolInput.on('input', () => {
            clearTimeout(searchTimeout);
            const inputValue = symbolInput.val();
            // é˜²æŠ–ï¼šå»¶è¿Ÿæœç´¢
            searchTimeout = setTimeout(async () => {
                const results = await get_symbol(inputValue);
                showResults(results);
            }, 100);
        });

        // é”®ç›˜å¯¼èˆª
        symbolInput.on('keydown', (e) => {
            const items = symbolResults.find('.symbol-result-item:not(:contains(æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è‚¡ç¥¨))');

            if (symbolResults.hasClass('hidden')) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentSelectedIndex = Math.min(currentSelectedIndex + 1, items.length - 1);
                highlightItem(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentSelectedIndex = Math.max(currentSelectedIndex - 1, 0);
                highlightItem(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentSelectedIndex >= 0 && currentSelectedIndex < items.length) {
                    const stock = items.eq(currentSelectedIndex).data('stock');
                    selectStock(stock);
                } else {
                    symbolResults.addClass('hidden');
                }
            } else if (e.key === 'Escape') {
                symbolResults.addClass('hidden');
            }
        });

        // é«˜äº®é€‰ä¸­çš„é¡¹
        const highlightItem = (items) => {
            items.removeClass('highlight');
            if (currentSelectedIndex >= 0 && currentSelectedIndex < items.length) {
                const selectedItem = items.eq(currentSelectedIndex);
                selectedItem.addClass('highlight');
                // æ»šåŠ¨åˆ°é€‰ä¸­é¡¹
                symbolResults.scrollTop(selectedItem.position().top - symbolResults.position().top);
            }
        };

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ç»“æœåˆ—è¡¨
        $(document).on('click', (e) => {
            if (!$(e.target).closest('.symbol-input-wrapper').length) {
                symbolResults.addClass('hidden');
            }
        });

        // ä»localStorageåŠ è½½ä¸Šæ¬¡é€‰æ‹©çš„è‚¡ç¥¨
        const savedStock = localStorage.getItem('selectedStock');
        if (savedStock) {
            try {
                const stock = JSON.parse(savedStock);
                symbolInput.val(stock.name + '[' + stock.code + ']');
            } catch (error) {
                console.error('åŠ è½½ä¿å­˜çš„è‚¡ç¥¨ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // ä»localStorageè·å–ä¿å­˜çš„é…ç½®æˆ–ä½¿ç”¨é»˜è®¤å€¼
        const getSavedConfig = () => {
            const saved = localStorage.getItem('chartConfig');
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                gridCount: 4,
                playInterval: 3,
                theme: 'light',
                showGrid: true,
                showLegend: true,
                dataPoints: 'show'
            };
        };

        // ä¿å­˜é…ç½®åˆ°localStorage
        const saveConfigToStorage = (config) => {
            localStorage.setItem('chartConfig', JSON.stringify(config));
        };

        // è·å–å·²ä¿å­˜çš„é…ç½®
        const savedConfig = getSavedConfig();
        let gridCount = savedConfig.gridCount;

        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨
        window.addEventListener('resize', function () {
            multiGridChart.resize();
        });

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        let isDarkTheme = false;

        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ä¸»é¢˜è®¾ç½®
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            isDarkTheme = true;
            $('body').addClass('dark-theme');
            $('#theme-toggle').text('â˜€ï¸');
        }

        $('#theme-toggle').click(function () {
            if (!isDarkTheme) {
                // åˆ‡æ¢åˆ°æ·±è‰²ä¸»é¢˜
                $('body').addClass('dark-theme');
                $(this).text('â˜€ï¸');
                localStorage.setItem('theme', 'dark');
                isDarkTheme = true;
            } else {
                // åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜
                $('body').removeClass('dark-theme');
                $(this).text('ğŸŒ™');
                localStorage.setItem('theme', 'light');
                isDarkTheme = false;
            }

            // é‡æ–°è®¾ç½®å›¾è¡¨ä¸»é¢˜
            const currentOption = multiGridChart.getOption();
            if (currentOption && currentOption.series && currentOption.series.length > 0) {
                // é‡æ–°ç”Ÿæˆé…ç½®ä»¥åº”ç”¨æ–°ä¸»é¢˜
                $('#query-btn').trigger('click');
            }
        });

        // å› å­åº“é€‰æ‹©å˜åŒ–æ—¶è”åŠ¨æ›´æ–°å› å­ä¸‹æ‹‰åˆ—è¡¨
        $('#factor-database-select').change(function () {
            const dbVolume = $(this).val();
            const factorData = JSON.parse(localStorage.getItem('factorData')) || [];

            const selectedDb = factorData.find(db => db.db_volume === dbVolume);
            if (selectedDb) {
                updateFactorOptions(selectedDb.factors);
            }
        });

        const initTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                $('body').addClass('dark-theme');
                $('#theme-toggle').text('â˜€ï¸');
                isDarkTheme = true;
            } else {
                $('body').removeClass('dark-theme');
                $('#theme-toggle').text('ğŸŒ™');
                isDarkTheme = false;
            }
        };

        // åˆå§‹åŒ–ä¸»é¢˜
        initTheme();

        // æ¨¡æ‹Ÿåå°å‡½æ•°init_factor_data()
        const init_factor_data = () => {
            return [
                {
                    "db_name": "TICK",
                    "db_volume": "tick",
                    "factors": [
                        {
                            "name": "æˆäº¤ä»· [PRICE]",
                            "volume": "price",
                        },
                        {
                            "name": "å¼€ç›˜ä»· [OPEN]",
                            "volume": "open",
                        },
                        {
                            "name": "æœ€é«˜ä»· [HIGH]",
                            "volume": "high",
                        },
                        {
                            "name": "æœ€ä½ä»· [LOW]",
                            "volume": "low",
                        },
                        {
                            "name": "æˆäº¤é‡ [VOLUME]",
                            "volume": "last-volume",
                        },
                        {
                            "name": "æˆäº¤é¢ [AMOUNT]",
                            "volume": "last-amount",
                        }
                    ]
                },
                {
                    "db_name": "ANALYSIS",
                    "db_volume": "analysis",
                    "factors": [
                        {
                            "name": "å‰é©±å€¼ [PEB]",
                            "volume": "å‰é©±å€¼",
                        },
                        {
                            "name": "æœ€é«˜ä»· [PSD]",
                            "volume": "æœ€é«˜ä»·",
                        },
                        {
                            "name": "åé©±å€¼ [PIB]",
                            "volume": "åé©±å€¼",
                        }
                    ]
                }
            ];
        };

        // åˆå§‹åŒ–å› å­åº“å’Œå› å­ä¸‹æ‹‰åˆ—è¡¨
        const initFactorSelect = () => {
            const factorData = init_factor_data();
            const dbSelect = $('#factor-database-select');
            const factorSelect = $('#factor-select');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            dbSelect.empty();
            factorSelect.empty();

            // æ·»åŠ å› å­åº“é€‰é¡¹
            factorData.forEach(db => {
                dbSelect.append($('<option>', {
                    value: db.db_volume,
                    text: db.db_name
                }));
            });

            // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªå› å­åº“çš„å› å­
            if (factorData.length > 0) {
                updateFactorOptions(factorData[0].factors);
            }

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('factorData', JSON.stringify(factorData));
        };

        // æ ¹æ®é€‰æ‹©çš„å› å­åº“æ›´æ–°å› å­é€‰é¡¹
        const updateFactorOptions = (factors) => {
            const factorSelect = $('#factor-select');
            factorSelect.empty();

            factors.forEach(factor => {
                factorSelect.append($('<option>', {
                    value: factor.volume,
                    text: factor.name
                }));
            });
        };

        // åˆå§‹åŒ–å› å­åº“å’Œå› å­ä¸‹æ‹‰åˆ—è¡¨
        initFactorSelect();

        // åˆå§‹åŒ–å¹¶åŒæ­¥grid-selectå’Œgrid-countä¸‹æ‹‰åˆ—è¡¨
        const syncGridSelects = () => {
            const savedConfig = getSavedConfig();
            const gridValue = savedConfig.gridCount || 4;

            // é¦–å…ˆç¡®ä¿grid-selectæœ‰å®Œæ•´çš„é€‰é¡¹
            if ($('#grid-select option').length === 0) {
                for (let i = 0; i < gridValue; i++) {
                    $('#grid-select').append($('<option>', {
                        value: i,
                        text: `æ•°æ®è§†å›¾[${i + 1}]`
                    }));
                }
            }

            $('#grid-select').val(0);
            $('#grid-count').val(gridValue);
        };

        // åŒæ­¥grid-selectå’Œgrid-countä¸‹æ‹‰åˆ—è¡¨
        syncGridSelects();

        // å½“grid-selectå˜åŒ–æ—¶ï¼ŒåŒæ­¥åˆ°grid-count
        $('#grid-select').change(function () {
            const value = $(this).val();
            $('#grid-count').val(value);
        });

        // å›¾è¡¨é…ç½®æ¨¡æ¿
        const getMultiGridChartOption = () => {
            const isDark = $('body').hasClass('dark-theme');
            const textColor = isDark ? '#e4e7ed' : '#606266';
            const axisLineColor = isDark ? '#4c4d4f' : '#e4e7ed';
            const splitLineColor = isDark ? '#3d3d3d' : '#f5f7fa';
            const backgroundColor = isDark ? '#1e1e1e' : '#fff';

            const availableHeight = 100 - 8; // å‡å°‘é¡¶éƒ¨é¢„ç•™ç©ºé—´
            const gridHeight = (availableHeight - (gridCount - 1) * 2) / gridCount;

            // ç”Ÿæˆgridé…ç½®
            const grids = [];
            for (let i = 0; i < gridCount; i++) {
                grids.push({
                    id: `grid${i}`,
                    left: '1%',
                    right: '1%',
                    top: (2 + i * (gridHeight + 2.8)) + '%',
                    height: gridHeight + '%',
                    containLabel: true
                });
            }

            // ç”ŸæˆxAxisé…ç½®
            const xAxes = [];
            for (let i = 0; i < gridCount; i++) {
                xAxes.push({
                    gridIndex: i,
                    type: 'category',
                    boundaryGap: false,
                    data: [],
                    axisLine: {lineStyle: {color: axisLineColor}},
                    axisLabel: {color: textColor, fontSize: 10},
                    axisTick: {show: false}
                });
            }

            // ç”ŸæˆyAxisé…ç½®
            const yAxes = [];
            for (let i = 0; i < gridCount; i++) {
                yAxes.push({
                    gridIndex: i,
                    type: 'value',
                    scale: true,
                    boundaryGap: false,
                    splitArea: {
                        show: true
                    },
                    nameTextStyle: {color: textColor, fontSize: 12},
                    axisLine: {lineStyle: {color: axisLineColor}},
                    axisLabel: {color: textColor, fontSize: 10},
                    splitLine: savedConfig.showGrid ? {lineStyle: {color: splitLineColor}} : {show: false}
                });
            }

            // æ ¹æ®æ•°æ®ç‚¹æ˜¾ç¤ºé…ç½®è°ƒæ•´æ ·å¼
            if (savedConfig.dataPoints === 'hide') {
                series.forEach(s => {
                    s.showSymbol = false;
                });
            } else if (savedConfig.dataPoints === 'hover') {
                series.forEach(s => {
                    s.showSymbol = false;
                    s.emphasis = {
                        showSymbol: true,
                        symbolSize: 6
                    };
                });
            }

            return {
                backgroundColor: backgroundColor,
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: isDark ? 'rgba(45, 45, 45, 0.9)' : 'rgba(50, 50, 50, 0.9)',
                    borderColor: isDark ? '#4c4d4f' : '#333',
                    textStyle: {color: isDark ? '#e4e7ed' : '#fff'},
                    axisPointer: {
                        type: 'cross',
                        link: [{xAxisIndex: Array.from({length: gridCount}, (_, i) => i)}]
                    }
                },

                legend: savedConfig.showLegend ? {
                    data: [],
                    top: 2,
                    left: 'center',
                    itemGap: 10,
                    textStyle: {
                        color: textColor,
                        fontSize: 12
                    }
                } : {show: false},

                axisPointer: {
                    link: [{xAxisIndex: Array.from({length: gridCount}, (_, i) => i)}]
                },
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: Array.from({length: gridCount}, (_, i) => i),
                        start: 0,
                        end: 100,
                        filterMode: 'filter'
                    },
                    {
                        type: 'slider',
                        show: true,
                        top: '96%',
                        height: 12,
                        realtime: true,
                        start: 0,
                        end: 100,
                        borderRadius: 0,
                        handleSize: '100%',
                        xAxisIndex: Array.from({length: gridCount}, (_, i) => i),
                        brushStyle: {borderType: [5, 10], borderWidth: 0}
                    }
                ],
                grid: grids,
                xAxis: xAxes,
                yAxis: yAxes,
                series: []
            };
        };

        const option = getMultiGridChartOption();

        multiGridChart.setOption(option, true);

        // ä»æ•°æ®åº“æ›´æ–°æŸ¥è¯¢å†å²è®°å½•æ•°é‡æ˜¾ç¤º
        function updateHistoryCountFromDB() {
            db.query_history.count().then(count => {
                $('#history-count').text(count);
            }).catch(error => {
                console.error('è·å–æŸ¥è¯¢è®°å½•æ•°é‡å¤±è´¥:', error);
            });
        }

        updateHistoryCountFromDB()

        // è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
        let isPlaying = false;
        let playInterval;

        let play_data = {}

        $('#play-btn').click(function () {

            if (query_list.length === 0) {
                alert('è¯·å…ˆä¿å­˜æŸ¥è¯¢ï¼');
                return;
            }

            // æ¸…é™¤ä¹‹å‰çš„æ’­æ”¾é—´éš”
            if (playInterval) {
                clearInterval(playInterval);
            }

            let query = query_list[query_list.length - 1];
            console.log(query);

            // è·å–å¯¹åº”çš„ç³»åˆ—æ•°æ®
            let targetSeries = option.series.find(s => s.name === query.cs);
            if (!targetSeries) {
                alert('æœªæ‰¾åˆ°å¯¹åº”çš„ç³»åˆ—æ•°æ®');
                return;
            }

            // ä¿å­˜åŸå§‹æ•°æ®å¹¶æ¸…ç©ºå½“å‰æ•°æ®
            play_data[query.cs] = [...targetSeries.data]; // ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦åˆ›å»ºå‰¯æœ¬
            targetSeries.data = [];

            // æ›´æ–°å›¾è¡¨
            multiGridChart.setOption({
                series: [{
                    name: query.cs,
                    data: targetSeries.data
                }]
            }, {replaceMerge: ['series']});

            let play_index = 0;

            playInterval = setInterval(function () {
                if (play_index < play_data[query.cs].length) {
                    console.log(play_data[query.cs][play_index]);
                    // æ­£ç¡®çš„æ•°æ®æ¨é€æ–¹å¼ï¼Œå»æ‰å¤šä½™çš„æ•°ç»„åµŒå¥—
                    targetSeries.data.push(play_data[query.cs][play_index]);

                    // ä½¿ç”¨ setOption æ›´æ–°æ•°æ®
                    multiGridChart.setOption({
                        series: [
                            {
                                data:targetSeries
                            }
                        ]
                    },true);

                    play_index++;
                } else {
                    // æ’­æ”¾å®Œæˆï¼Œæ¸…é™¤é—´éš”
                    clearInterval(playInterval);
                    playInterval = null;
                }
            }, 500);

            // if (isPlaying) {
            //     // æš‚åœæ’­æ”¾
            //     clearInterval(playInterval);
            //     $(this).text('â–¶'); // æ’­æ”¾å›¾æ ‡
            //     isPlaying = false;
            // } else {
            //     // å¼€å§‹æ’­æ”¾
            //     $(this).text('â¸'); // æš‚åœå›¾æ ‡
            //     isPlaying = true;
            //
            //     // æ¯éš”3ç§’è‡ªåŠ¨ç‚¹å‡»ä¸‹ä¸€æ¡æŒ‰é’®
            //     playInterval = setInterval(function () {
            //         $('#next-btn').trigger('click');
            //     }, 3000);
            // }
        });

        // å½“ç‚¹å‡»ä¸Šä¸€æ¡æˆ–ä¸‹ä¸€æ¡æŒ‰é’®æ—¶ï¼Œå¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°è®¡æ—¶
        $('#prev-btn, #next-btn').click(function () {
            if (isPlaying) {
                clearInterval(playInterval);
                playInterval = setInterval(function () {
                    $('#next-btn').trigger('click');
                }, 3000);
            }
        });

        const query_list = [];

        // æŸ¥è¯¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#query-btn').click(function () {

            if (isPlaying) {
                clearInterval(playInterval);
                $('#play-btn').text('â–¶');
                isPlaying = false;
            }

            const startTime = $('#start-time').val();
            const endTime = $('#end-time').val();

            const fdb = $('#factor-database-select').val();
            const tb = $('#symbol-hidden').val();
            const cs = $('#factor-select').val();

            const grid = parseInt($('#grid-select').val());
            const viewType = $('#view-type-select').val();

            if (!startTime || !endTime) {
                alert('è¯·é€‰æ‹©å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´');
                return;
            }

            if (new Date(startTime) >= new Date(endTime)) {
                alert('å¼€å§‹æ—¶é—´å¿…é¡»æ—©äºç»“æŸæ—¶é—´');
                return;
            }

            // ç¦ç”¨æŸ¥è¯¢æŒ‰é’®
            $(this).prop('disabled', true).text('æŸ¥è¯¢ä¸­...');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            $('#chart-loading').show();

            $.ajax({
                url: uri['factor-query'],
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    "db": fdb,
                    "tb": tb,
                    "cs": cs,
                    "start_time": new Date(startTime).getTime() / 1000,
                    "end_time": new Date(endTime).getTime() / 1000,
                }),
                success: function (response) {
                    console.log(response);
                    option.xAxis[grid].data = response.data['created_at'];
                    option.legend.data.push(cs);
                    option.series.push(
                        {
                            name: cs,
                            type: viewType,
                            xAxisIndex: grid,
                            yAxisIndex: grid,
                            data: response.data.data,
                            smooth: true,
                            symbolSize: 3,
                            showSymbol: false,
                            symbol: 'circle',
                            sampling: 'lttb',
                            lineStyle: {color: '#409eff', width: 0.8},
                            itemStyle: {color: '#409eff'}
                        },
                    )

                    multiGridChart.setOption(option, true);

                    let query_record = {
                        time: new Date().getTime(),
                        db: fdb,
                        tb: tb,
                        cs: cs,
                        grid: grid,
                        line_width: parseFloat($('#line-width').val()),
                        color: $('#series-color').val(),
                        view_type: viewType,
                        start_time: new Date(startTime).getTime() / 1000,
                        end_time: new Date(endTime).getTime() / 1000,
                    }

                    query_list.push(query_record)

                    db.query_history.add(query_record).then(() => {
                        updateHistoryCountFromDB();
                    }).catch(error => {
                        console.error('ä¿å­˜æŸ¥è¯¢è®°å½•å¤±è´¥:', error);
                    });
                },
                error: function (xhr, status, error) {
                    $('#chart-loading').hide();
                    $('#query-btn').prop('disabled', false).text('æŸ¥è¯¢æ•°æ®');
                    console.error('æŸ¥è¯¢é”™è¯¯:', error);
                },
                complete: function () {
                    $('#chart-loading').hide();
                    $('#query-btn').prop('disabled', false).text('æŸ¥è¯¢æ•°æ®');
                }
            })

        });

        $('#cg-btn').click(function () {

            cs = $('#factor-select').val();

            option.series.forEach(series => {
                if (series.name === cs) {
                    series.type === 'line' ? series.type = 'bar' : series.type = 'line';
                    console.log(series.type);
                }
            });

            console.log(option.series);

            multiGridChart.setOption(option, true);
        });

        $('#delete-btn').click(function () {
            cs = $('#factor-select').val();

            const legend_list = option.legend.data;
            const index = legend_list.indexOf(cs);
            if (index > -1) {
                option.legend.data.splice(index, 1);
                multiGridChart.setOption(option, true);
            }

            // æŸ¥æ‰¾åç§°å¯¹åº”çš„ç´¢å¼•
            const cs_index = option.series.findIndex(series => series.name === cs);

            // å­˜åœ¨åˆ™åˆ é™¤
            if (cs_index !== -1) {
                option.series.splice(cs_index, 1)
                // multiGridChart.clear();
                multiGridChart.setOption(option, true);
            }
        });

        // é…ç½®æ¨¡æ€æ¡†åŠŸèƒ½
        const configModal = $('#config-modal');
        const configBtn = $('#config-btn');
        const cancelConfigBtn = $('#cancel-config');
        const saveConfigBtn = $('#save-config');

        // æ‰“å¼€é…ç½®æ¨¡æ€æ¡†
        configBtn.click(function () {
            configModal.show();
            // æ ¹æ®å½“å‰è®¾ç½®åˆå§‹åŒ–é…ç½®é¡¹
            $('#play-interval').val(playInterval ? playInterval / 1000 : 3);
            if (isDarkTheme) {
                $('#chart-theme').val('dark');
            } else {
                $('#chart-theme').val('light');
            }
            // æ·»åŠ ç½‘æ ¼æ•°é‡é€‰æ‹©å™¨çš„åˆå§‹åŒ–
            $('#grid-count').val(savedConfig.gridCount);

            // æ·»åŠ å…¶ä»–é…ç½®é¡¹çš„åˆå§‹åŒ–
            $('#show-grid').prop('checked', savedConfig.showGrid);
            $('#show-legend').prop('checked', savedConfig.showLegend);
            $('#data-points').val(savedConfig.dataPoints);
        });

        // å…³é—­é…ç½®æ¨¡æ€æ¡†
        cancelConfigBtn.click(function () {
            configModal.hide();
        });

        // ä¿å­˜é…ç½®
        saveConfigBtn.click(function () {
            // è·å–é…ç½®å€¼
            const interval = parseInt($('#play-interval').val()) * 1000;
            const theme = $('#chart-theme').val();
            const showGrid = $('#show-grid').is(':checked');
            const showLegend = $('#show-legend').is(':checked');
            const dataPoints = $('#data-points').val();
            // æ·»åŠ è·å–ç½‘æ ¼æ•°é‡çš„é€»è¾‘
            const newGridCount = parseInt($('#grid-count').val());

            // æ›´æ–°é…ç½®å¯¹è±¡
            const newConfig = {
                gridCount: newGridCount,
                playInterval: interval / 1000,
                theme: theme,
                showGrid: showGrid,
                showLegend: showLegend,
                dataPoints: dataPoints
            };

            // ä¿å­˜é…ç½®åˆ°localStorage
            saveConfigToStorage(newConfig);

            // åº”ç”¨ä¸»é¢˜è®¾ç½®
            if (theme === 'dark' && !isDarkTheme) {
                $('#theme-toggle').trigger('click');
            } else if (theme === 'light' && isDarkTheme) {
                $('#theme-toggle').trigger('click');
            }

            // åº”ç”¨è‡ªåŠ¨æ’­æ”¾é—´éš”è®¾ç½®
            if (isPlaying) {
                clearInterval(playInterval);
                playInterval = setInterval(function () {
                    $('#next-btn').trigger('click');
                }, interval);
            }

            // å¦‚æœç½‘æ ¼æ•°é‡æ”¹å˜ï¼Œæ›´æ–°å…¨å±€å˜é‡å¹¶é‡æ–°æŸ¥è¯¢æ•°æ®ä»¥åˆ·æ–°å›¾è¡¨
            if (newGridCount !== gridCount) {
                gridCount = newGridCount;
                let grid_select = $('#grid-select')
                grid_select.empty();
                grid_select.val(newGridCount);

                for (let i = 1; i <= newGridCount; i++) {
                    grid_select.append($('<option>', {
                        value: i,
                        text: `æ•°æ®è§†å›¾[${i}]`
                    }));
                }

                $('#query-btn').trigger('click'); // é‡æ–°æŸ¥è¯¢æ•°æ®ä»¥æ›´æ–°å›¾è¡¨
            }

            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šé…ç½®é¡¹çš„åº”ç”¨é€»è¾‘
            console.log('ä¿å­˜é…ç½®:', {
                interval: interval / 1000,
                theme: theme,
                showGrid: showGrid,
                showLegend: showLegend,
                dataPoints: dataPoints,
                gridCount: newGridCount
            });

            // å…³é—­æ¨¡æ€æ¡†
            configModal.hide();
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
        configModal.click(function (event) {
            if (event.target === configModal[0]) {
                configModal.hide();
            }
        });

        // ä¿®æ”¹æ˜¾ç¤ºæ¨¡æ€æ¡†çš„ä»£ç ï¼Œæ ¹æ®seriesç±»å‹æ˜¾ç¤º/éšè—çº¿æ¡ç²—ç»†é…ç½®
        $('#color-config-btn').click(function () {
            const cs = $('#factor-select').val();
            if (!cs) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæŒ‡æ ‡');
                return;
            }

            const series = option.series.find(s => s.name === cs);
            if (series) {
                $('#series-color').val(series.itemStyle?.color || '#000000');

                // å¦‚æœæ˜¯çº¿å›¾ï¼Œæ˜¾ç¤ºçº¿æ¡ç²—ç»†é…ç½®å¹¶è®¾ç½®å½“å‰å€¼
                if (series.type === 'line') {
                    $('#line-width-group').show();
                    $('#line-width').val(series.lineStyle?.width || 2);
                    $('#line-width-value').text($('#line-width').val());
                } else {
                    $('#line-width-group').hide();
                }
            }

            $('#color-modal').show();
        });

        // ä¿®æ”¹ä¿å­˜é…ç½®çš„ä»£ç 
        $('#save-color').click(function () {
            const color = $('#series-color').val();
            const lineWidth = parseFloat($('#line-width').val());
            const cs = $('#factor-select').val();

            option.series.forEach(series => {
                if (series.name === cs) {
                    series.itemStyle = series.itemStyle || {};
                    series.itemStyle.color = color;

                    // å¦‚æœæ˜¯çº¿å›¾ï¼Œè®¾ç½®çº¿æ¡é¢œè‰²å’Œç²—ç»†
                    if (series.type === 'line') {
                        series.lineStyle = series.lineStyle || {};
                        series.lineStyle.color = color;
                        series.lineStyle.width = lineWidth;
                    }
                }
            });

            multiGridChart.setOption(option, true);
            $('#color-modal').hide();
        });

        // æ·»åŠ çº¿æ¡ç²—ç»†å€¼æ˜¾ç¤º
        $('#line-width').on('input', function () {
            $('#line-width-value').text($(this).val());
        });

        // å–æ¶ˆé¢œè‰²é€‰æ‹©
        $('#cancel-color').click(function () {
            $('#color-modal').hide();
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        $('#color-modal').click(function (event) {
            if (event.target === $('#color-modal')[0]) {
                $('#color-modal').hide();
            }
        });

        // æ˜¾ç¤ºå†å²è®°å½•
        function showHistory() {
            const tbody = $('#history-table tbody');
            tbody.empty();
            //  query_history: '++time, db, tb, cs, grid, line_width, color, view_type, start_time, end_time',
            db.query_history.orderBy('time').reverse().toArray().then(records => {
                records.forEach(record => {
                    const row = $('<tr>');
                    row.append(`<td>${record.tb}</td>`);
                    // æ ¼å¼åŒ–å¼€å§‹æ—¶é—´ï¼Œç²¾ç¡®åˆ°ç§’
                    const startTime = new Date(record.start_time * 1000).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    row.append(`<td>${startTime}</td>`);
                    // æ ¼å¼åŒ–ç»“æŸæ—¶é—´ï¼Œç²¾ç¡®åˆ°ç§’
                    const endTime = new Date(record.end_time * 1000).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    row.append(`<td>${endTime}</td>`);
                    row.append(`<td>${record.db}</td>`);
                    row.append(`<td>${record.cs}</td>`);
                    row.append(`<td>${record.view_type}</td>`);
                    row.append(`<td style="background-color:${record.color}; width:20px;"></td>`);
                    row.append(`<td>${record.view_type === 'line' ? record.line_width : '-'}</td>`);
                    tbody.append(row);
                });

                $('#history-modal').show();
            });
        }

        // ç‚¹å‡»çŠ¶æ€æ æ˜¾ç¤ºå†å²è®°å½•
        $('#query-history-div').click(showHistory);

        $('#clear-history').click(() => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŸ¥è¯¢å†å²è®°å½•å—ï¼Ÿ')) {
                $('#history-table tbody').empty();
                db.query_history.clear().then(() => {
                    updateHistoryCountFromDB()
                });
            }
            $('#history-modal').hide();
        });

        function saveLayoutToHistory() {

            if (query_list.length === 0) {
                window.alert('è¯·å…ˆæ·»åŠ æŸ¥è¯¢');
                return;
            }

            if (gridCount <= 0) {
                window.alert('è¯·å…ˆé€‰æ‹©ç½‘æ ¼æ•°');
                return;
            }

            const layout = {
                grid_count: gridCount,
                queries: query_list,
                save_time: Date.now()
            };

            db.page_layout.add(layout).then(() => {
                updateLayoutHistoryCount();
            });
        }

        $('#save-page-layout-btn').click(saveLayoutToHistory)

        $('#layout-history-div').click(function () {
                db.page_layout.orderBy('save_time').reverse().toArray().then(records => {
                    records.forEach(record => {
                        console.log(record)
                    })
                })
            }
        )

        // æ›´æ–°é¡µé¢å¸ƒå±€å†å²è®°å½•æ•°é‡æ˜¾ç¤º
        function updateLayoutHistoryCount() {
            db.page_layout.count().then(count => {
                $('#layout-history-count').text(count);
            });
        }

        // åˆå§‹åŒ–æ—¶æ›´æ–°è®¡æ•°
        updateLayoutHistoryCount();

        // æ›´æ–°æ—¶é—´å‡½æ•°
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            $('#current-time').text(timeString);
        }

        // åˆå§‹æ›´æ–°æ—¶é—´å¹¶è®¾ç½®å®šæ—¶å™¨
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        $('#close-history').click(() => {
            $('#history-modal').hide();
        })

    });
</script>
</body>

</html>